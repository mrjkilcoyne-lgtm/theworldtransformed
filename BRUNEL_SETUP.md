# The Brunel Engine - Setup Guide

**Turn frustrations into actionable insight through AI-powered structured interviews.**

---

## Quick Start

1. **Install dependencies**
   ```bash
   npm install
   ```

2. **Configure environment**
   ```bash
   cp .env.example .env
   # Edit .env and add your API keys
   ```

3. **Run development server**
   ```bash
   npm run dev
   ```

4. **Access The Brunel Engine**
   Open `http://localhost:4321/brunel` in your browser

---

## Configuration

### Required: Anthropic API Key

The Brunel Engine uses Claude for AI report generation.

1. Get an API key from [Anthropic Console](https://console.anthropic.com/)
2. Add to `.env`:
   ```
   ANTHROPIC_API_KEY=your_key_here
   ```

**Cost estimate:**
- Basic tier: ~$0.01 per report (Claude Sonnet)
- Standard tier: ~$0.02 per report (Claude Sonnet, longer)
- Council tier: ~$0.15 per report (Claude Opus)

The 10p/50p pricing covers these API costs with minimal margin.

### Optional: Stripe Payment Processing

For Standard (10p) and Council (50p) tier payments.

1. Get API keys from [Stripe Dashboard](https://dashboard.stripe.com/apikeys)
2. Add to `.env`:
   ```
   STRIPE_SECRET_KEY=sk_test_...
   STRIPE_PUBLISHABLE_KEY=pk_test_...
   ```

**Note:** If Stripe is not configured, the system will still work but won't collect payments. Useful for testing or running as a free service.

### Optional: Email Follow-ups

For 1-month and 1-year check-ins.

**Options:**
- SendGrid
- Mailgun
- AWS SES
- Postmark
- etc.

**Implementation needed:**
- Update `src/pages/api/register-followup.ts` with your email service
- Add scheduling system (cron jobs, background workers, or service like Inngest/Trigger.dev)
- Store follow-up schedule in a database

---

## Architecture

### Frontend (React + Astro)

```
src/
├── components/
│   └── BrunelEngine.tsx       # Main interview component
└── pages/
    ├── brunel.astro           # Brunel Engine page
    └── api/
        ├── generate-report.ts # AI report generation
        ├── create-payment.ts  # Stripe checkout
        └── register-followup.ts # Email registration
```

### Interview Flow

1. **Welcome** - Set expectations, privacy notice
2. **Interview** - 6 structured questions
3. **Tier Selection** - Basic (free), Standard (10p), Council (50p)
4. **Payment** (if paid tier) - Stripe Checkout
5. **Report Generation** - Claude API call
6. **Report Display** - Private, actionable insights
7. **Follow-up** - Optional email registration

### Tiers

| Tier | Price | Model | Max Tokens | Features |
|------|-------|-------|------------|----------|
| Basic | Free | Claude Sonnet | 1024 | Single analysis, core pathways |
| Standard | 10p | Claude Sonnet | 2048 | Enhanced analysis, multiple perspectives |
| Council | 50p | Claude Opus | 4096 | Multi-model synthesis, contrarian views |

---

## Privacy & Data

**Current implementation:**
- No data persistence (unless you add it)
- Reports generated on-the-fly
- Follow-up emails only stored if user opts in
- All processing server-side

**For production:**
- Add explicit consent flows
- GDPR/privacy policy compliance
- Data retention policies
- Encryption at rest and in transit

---

## Development

### Available Commands

```bash
npm run dev       # Start dev server
npm run build     # Build for production
npm run preview   # Preview production build
npm run format    # Format code with Prettier
npm run type-check # Check TypeScript types
```

### Testing Locally

1. Start dev server: `npm run dev`
2. Navigate to `http://localhost:4321/brunel`
3. Complete the interview
4. Select a tier
5. Generate report (will use fallback if API key not set)

### Testing with API

1. Add `ANTHROPIC_API_KEY` to `.env`
2. Restart dev server
3. Complete interview
4. Reports will be generated by Claude

---

## Deployment

### Static Hosting (GitHub Pages, Netlify, Vercel)

**Challenge:** The Brunel Engine requires server-side API routes, which don't work on pure static hosting.

**Solutions:**

1. **Vercel** (recommended)
   - Supports Astro's hybrid mode
   - Environment variables in dashboard
   - Deploy: `vercel`

2. **Netlify**
   - Enable Netlify Functions
   - Configure environment variables
   - Deploy: `netlify deploy --prod`

3. **Self-hosted**
   - Use `node` adapter for Astro
   - Deploy to VPS/cloud server
   - Set up environment variables
   - Use process manager (PM2, systemd)

### Environment Variables

Set these in your hosting provider's dashboard:
- `ANTHROPIC_API_KEY` (required)
- `STRIPE_SECRET_KEY` (optional)
- `STRIPE_PUBLISHABLE_KEY` (optional)
- `PUBLIC_SITE_URL` (your domain)

---

## Customization

### Changing Interview Questions

Edit `src/components/BrunelEngine.tsx`:

```typescript
const interviewFlow: Question[] = [
  {
    id: 'initial',
    question: "Your question here",
    followUp: "Additional context",
    requiresConfirmation: false // true for yes/no questions
  },
  // ...
];
```

### Changing Report Structure

Edit `src/pages/api/generate-report.ts`:

```typescript
const systemPrompt = `Your custom prompt for Claude...`;
```

### Changing Pricing

Edit tier prices in:
- `src/components/BrunelEngine.tsx` (display)
- `src/pages/api/create-payment.ts` (Stripe amounts)

---

## Roadmap

### MVP (Current)
- ✅ 6-question interview
- ✅ Three tiers (Basic/Standard/Council)
- ✅ AI report generation
- ✅ Follow-up email registration (stub)
- ✅ Stripe payment integration (stub)

### Production Ready
- ⬜ Full Stripe integration with webhooks
- ⬜ Email service integration (SendGrid/Mailgun)
- ⬜ Database for follow-up scheduling
- ⬜ User accounts (optional)
- ⬜ Report history (optional)
- ⬜ GDPR compliance
- ⬜ Analytics and monitoring

### Future Enhancements
- ⬜ Entry point to Clamour (public policy tool)
- ⬜ Entry point to Claimer (binding mechanisms)
- ⬜ Outcome tracking dashboard
- ⬜ Community features
- ⬜ API for third-party integrations

---

## Troubleshooting

### "Failed to generate report"
- Check `ANTHROPIC_API_KEY` is set correctly
- Verify API key has sufficient credits
- Check console for detailed error messages

### Payment flow not working
- Verify `STRIPE_SECRET_KEY` is set
- Check Stripe dashboard for test mode
- Ensure success/cancel URLs are correct

### Build errors
- Run `npm install` to ensure all dependencies are installed
- Check TypeScript errors: `npm run type-check`
- Clear Astro cache: `rm -rf .astro`

---

## Support & Feedback

**Issues:** Create an issue in the GitHub repository

**Questions:** Contact Matt Kilcoyne via the main site

**Philosophy:** The Brunel Engine is about turning individual frustrations into collective insight. It's the entry point to the broader Clamour vision of policy wind tunnels and coordination mechanisms.

---

**Last Updated:** January 2026

**Version:** 1.0.0 (MVP)
